rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Hàm hỗ trợ kiểm tra Role an toàn (tránh lỗi khi document chưa tồn tại)
    function isAuthenticated() { return request.auth != null; }
    function hasUserDoc() { return exists(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function getUserData() { return get(/databases/$(database)/documents/users/$(request.auth.uid)).data; }
    
    function isAdmin() { return isAuthenticated() && hasUserDoc() && getUserData().role == 'admin'; }
    function isTeacher() { return isAuthenticated() && hasUserDoc() && getUserData().role == 'teacher'; }
    function isStudent() { return isAuthenticated() && hasUserDoc() && getUserData().role == 'student'; }

    // USERS
    match /users/{userId} {
      // Cho phép user tự đọc/ghi document của chính mình, hoặc admin có toàn quyền
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // EXAMS
    match /exams/{examId} {
      allow read: if isAuthenticated(); // Ai cũng xem được đề (nếu được giao)
      allow create: if isTeacher() && request.resource.data.uploadedBy == request.auth.uid;
      allow update, delete: if isAdmin() || (isTeacher() && resource.data.uploadedBy == request.auth.uid);
    }

    // QUESTIONS
    match /questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    // STUDENT EXAMS (Kết quả thi)
    match /student_exams/{docId} {
      // Học sinh xem bài mình, Giáo viên xem bài của học sinh mình, Admin xem hết
      allow read: if isAdmin() 
                  || (isStudent() && resource.data.studentId == request.auth.uid)
                  || (isTeacher() && resource.data.teacherId == request.auth.uid);
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
    }

    // PRACTICES
    match /practices/{docId} {
      allow read: if isAdmin() || (isStudent() && resource.data.studentId == request.auth.uid);
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
    }
    
    // CACHE (Chỉ cho phép đọc/ghi tự động từ App)
    match /question_cache/{hash} {
      allow read, write: if isTeacher() || isAdmin();
    }
    
    // API KEYS
    match /api_keys/{keyId} {
      allow read, write: if isTeacher() || isAdmin();
    }
  }
}
